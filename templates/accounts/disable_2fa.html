{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% translate "Désactiver l'authentification à 2 facteurs" %} - KefyStore{% endblock %}

{% block extra_css %}
<style>
    .disable-2fa-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: none;
        overflow: hidden;
    }
    
    .disable-2fa-header {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .disable-2fa-header h1 {
        font-weight: 700;
        margin: 0;
        font-size: 2rem;
    }
    
    .disable-2fa-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }
    
    .warning-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .warning-section .warning-icon {
        color: #856404;
        font-size: 1.5rem;
        margin-right: 0.5rem;
    }
    
    .warning-section h5 {
        color: #856404;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .warning-section ul {
        margin: 0;
        padding-left: 1.5rem;
    }
    
    .warning-section li {
        color: #856404;
        margin-bottom: 0.5rem;
    }
    
    .form-section {
        padding: 2rem;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        border: 2px solid #E9ECEF;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #c82333, #dc3545);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }
    
    .btn-outline-secondary {
        border: 2px solid #6c757d;
        color: #6c757d;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-outline-secondary:hover {
        background: #6c757d;
        border-color: #6c757d;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
    }
    
    .security-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .security-info h6 {
        color: #0c5460;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .security-info p {
        color: #0c5460;
        margin: 0;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="disable-2fa-card card">
                <div class="disable-2fa-header">
                    <h1>
                        <i class="fas fa-shield-alt me-3"></i>
                        {% translate "Désactiver le 2FA" %}
                    </h1>
                    <p>{% translate "Désactivez l'authentification à 2 facteurs pour votre compte" %}</p>
                </div>
                
                <div class="form-section">
                    <!-- Avertissement -->
                    <div class="warning-section">
                        <h5>
                            <i class="fas fa-exclamation-triangle warning-icon"></i>
                            {% translate "Attention !" %}
                        </h5>
                        <p class="mb-3">{% translate "La désactivation du 2FA réduira la sécurité de votre compte. Assurez-vous de :" %}</p>
                        <ul>
                            <li>{% translate "Utiliser un mot de passe fort et unique" %}</li>
                            <li>{% translate "Activer les notifications de connexion" %}</li>
                            <li>{% translate "Ne jamais partager vos identifiants" %}</li>
                            <li>{% translate "Surveiller régulièrement l'activité de votre compte" %}</li>
                        </ul>
                    </div>
                    
                    <!-- Formulaire de désactivation -->
                    <form method="post" id="disable-2fa-form">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2"></i>
                                {% translate "Confirmez votre mot de passe" %}
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="password" 
                                   name="password" 
                                   required
                                   placeholder="{% translate 'Entrez votre mot de passe actuel' %}">
                            <div class="invalid-feedback" id="password-error"></div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="confirm-disable" 
                                       name="confirm_disable" 
                                       required>
                                <label class="form-check-label" for="confirm-disable">
                                    {% translate "Je comprends les risques et souhaite désactiver l'authentification à 2 facteurs" %}
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'accounts:account_dashboard' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-arrow-left me-2"></i>
                                {% translate "Annuler" %}
                            </a>
                            <button type="submit" class="btn btn-danger" id="disable-btn">
                                <i class="fas fa-shield-alt me-2"></i>
                                {% translate "Désactiver le 2FA" %}
                            </button>
                        </div>
                    </form>
                    
                    <!-- Informations de sécurité -->
                    <div class="security-info">
                        <h6>
                            <i class="fas fa-info-circle me-2"></i>
                            {% translate "Conseils de sécurité" %}
                        </h6>
                        <p>
                            {% translate "Même sans 2FA, vous pouvez maintenir un bon niveau de sécurité en utilisant un mot de passe fort, en évitant les réseaux Wi-Fi publics pour les transactions sensibles, et en surveillant régulièrement l'activité de votre compte." %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('disable-2fa-form');
    const passwordField = document.getElementById('password');
    const confirmCheckbox = document.getElementById('confirm-disable');
    const disableBtn = document.getElementById('disable-btn');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validation
        let isValid = true;
        
        // Vérifier le mot de passe
        if (!passwordField.value.trim()) {
            passwordField.classList.add('is-invalid');
            document.getElementById('password-error').textContent = '{% translate "Le mot de passe est requis" %}';
            isValid = false;
        } else {
            passwordField.classList.remove('is-invalid');
            document.getElementById('password-error').textContent = '';
        }
        
        // Vérifier la confirmation
        if (!confirmCheckbox.checked) {
            isValid = false;
        }
        
        if (isValid) {
            // Confirmation finale
            if (confirm('{% translate "Êtes-vous sûr de vouloir désactiver l\'authentification à 2 facteurs ? Cette action réduira la sécurité de votre compte." %}')) {
                disableBtn.disabled = true;
                disableBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% translate "Désactivation..." %}';
                
                // Soumettre le formulaire
                form.submit();
            }
        } else {
            Utils.showNotification('{% translate "Veuillez corriger les erreurs ci-dessus" %}', 'warning');
        }
    });
    
    // Validation en temps réel
    passwordField.addEventListener('input', function() {
        if (this.value.trim()) {
            this.classList.remove('is-invalid');
            document.getElementById('password-error').textContent = '';
        }
    });
    
    confirmCheckbox.addEventListener('change', function() {
        if (this.checked) {
            disableBtn.classList.remove('disabled');
        } else {
            disableBtn.classList.add('disabled');
        }
    });
});
</script>
{% endblock %}
