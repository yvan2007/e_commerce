{% extends 'base/auth_base.html' %}
{% load static %}

{% block title %}Authentification à 2 facteurs - KefyStore{% endblock %}

{% block auth_content %}
    <div class="text-center mb-4">
        <div class="mb-3">
            <i class="fas fa-shield-alt fa-3x text-primary"></i>
        </div>
        <h4 class="fw-bold">Vérification de sécurité</h4>
        <p class="text-muted">Entrez le code de vérification envoyé à votre adresse email</p>
    </div>

    <!-- Alerts -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="verify2FAForm">
        {% csrf_token %}

        <div class="mb-4">
            <label for="code" class="form-label fw-semibold">Code de vérification</label>
            <input
                type="text"
                class="form-control form-control-lg text-center"
                id="code"
                name="code"
                placeholder="000000"
                maxlength="6"
                autofocus
                required
                pattern="[0-9]{6}"
                title="Entrez un code à 6 chiffres"
            >
            <small class="text-muted">Le code à 6 chiffres envoyé à votre email</small>
        </div>

        <div class="d-grid mb-3">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-check-circle me-2"></i>
                Vérifier le code
            </button>
        </div>

        <div class="text-center">
            <button type="button" class="btn btn-link text-decoration-none" onclick="resendCode()">
                <i class="fas fa-redo me-2"></i>
                Renvoyer le code
            </button>
        </div>
    </form>

    <!-- Help text -->
    <div class="mt-4">
        <div class="alert alert-info" role="alert">
            <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Besoin d'aide ?</h6>
            <p class="mb-0">Vérifiez votre dossier spam si vous ne recevez pas le code. Le code expire dans 10 minutes.</p>
        </div>
    </div>
{% endblock %}

{% block auth_js %}
<script>
// Auto-submit quand 6 chiffres sont entrés
document.getElementById('code').addEventListener('input', function(e) {
    const code = this.value.replace(/\D/g, '');
    this.value = code;

    if (code.length === 6) {
        // Auto-focus sur le bouton ou soumettre automatiquement
        setTimeout(() => {
            document.getElementById('verify2FAForm').submit();
        }, 500);
    }
});

// Resend code
function resendCode() {
    fetch('{% url "accounts:send_2fa_code" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'user_id': '{{ request.session.2fa_user_id }}',
            'method': 'email'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Un nouveau code a été envoyé à votre email.');
        } else {
            alert('Erreur: ' + (data.error || 'Impossible d\'envoyer le code'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de l\'envoi du code');
    });
}
</script>
{% endblock %}
