{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% translate "Avis et Commentaires" %} - KefyStore{% endblock %}

{% block extra_css %}
<style>
/* Animation de chargement KefyStore */
.kefy-loader {
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.kefy-loader.active {
  opacity: 1;
  visibility: visible;
}

.kefy-loader-content {
  text-align: center;
  color: white;
}

.kefy-loader svg {
  margin: 0 5px;
  width: 64px;
  height: 64px;
}

.kefy-loader-text {
  font-size: 24px;
  font-weight: bold;
  margin-top: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.kefy-loader-subtitle {
  font-size: 16px;
  margin-top: 10px;
  opacity: 0.9;
}

/* Animations */
.dash {
  animation:
    dashArray 2s ease-in-out infinite,
    dashOffset 2s linear infinite;
}

.spin {
  animation:
    spinDashArray 2s ease-in-out infinite,
    spin 8s ease-in-out infinite,
    dashOffset 2s linear infinite;
  transform-origin: center;
}

@keyframes dashArray {
  0% {
    stroke-dasharray: 0 1 359 0;
  }
  50% {
    stroke-dasharray: 0 359 1 0;
  }
  100% {
    stroke-dasharray: 359 1 0 0;
  }
}

@keyframes spinDashArray {
  0% {
    stroke-dasharray: 270 90;
  }
  50% {
    stroke-dasharray: 0 360;
  }
  100% {
    stroke-dasharray: 270 90;
  }
}

@keyframes dashOffset {
  0% {
    stroke-dashoffset: 365;
  }
  100% {
    stroke-dashoffset: 5;
  }
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  12.5%, 25% {
    transform: rotate(270deg);
  }
  37.5%, 50% {
    transform: rotate(540deg);
  }
  62.5%, 75% {
    transform: rotate(810deg);
  }
  87.5%, 100% {
    transform: rotate(1080deg);
  }
}

/* Dégradés KefyStore */
.gradient-kefy-1 {
  stroke: url(#kefy-gradient-1);
}

.gradient-kefy-2 {
  stroke: url(#kefy-gradient-2);
}

.gradient-kefy-3 {
  stroke: url(#kefy-gradient-3);
}

/* Styles pour les avis */
.review-card {
  border: none;
  border-radius: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.review-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.rating-stars {
  color: #ffc107;
  font-size: 1.2em;
}

.review-images {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.review-image {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.review-image:hover {
  transform: scale(1.1);
}

.helpful-btn {
  background: linear-gradient(45deg, #667eea, #764ba2);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  transition: all 0.3s ease;
}

.helpful-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

/* Animation de paiement */
.payment-loader {
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.payment-loader.active {
  opacity: 1;
  visibility: visible;
}

.payment-loader-content {
  text-align: center;
  color: white;
}

.payment-loader-text {
  font-size: 24px;
  font-weight: bold;
  margin-top: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.payment-loader-subtitle {
  font-size: 16px;
  margin-top: 10px;
  opacity: 0.9;
}

/* Animation de pulsation pour les boutons */
.pulse-animation {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}
</style>
{% endblock %}

{% block content %}
<!-- Loader KefyStore -->
<div class="kefy-loader" id="kefyLoader">
  <div class="kefy-loader-content">
    <svg class="absolute" width="0" height="0">
      <defs>
        <linearGradient id="kefy-gradient-1" x1="0" y1="62" x2="0" y2="2" gradientUnits="userSpaceOnUse">
          <stop stop-color="#667eea"></stop>
          <stop offset="1" stop-color="#764ba2"></stop>
        </linearGradient>
        <linearGradient id="kefy-gradient-2" x1="0" y1="64" x2="0" y2="0" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ffc107"></stop>
          <stop offset="1" stop-color="#ff6b6b"></stop>
          <animateTransform
            attributeName="gradientTransform"
            type="rotate"
            values="0 32 32;-270 32 32;-540 32 32;-810 32 32;-1080 32 32"
            dur="8s"
            keyTimes="0;0.125;0.25;0.375;0.5;0.625;0.75;0.875;1"
            repeatCount="indefinite">
          </animateTransform>
        </linearGradient>
        <linearGradient id="kefy-gradient-3" x1="0" y1="62" x2="0" y2="2" gradientUnits="userSpaceOnUse">
          <stop stop-color="#11998e"></stop>
          <stop offset="1" stop-color="#38ef7d"></stop>
        </linearGradient>
      </defs>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M15.75 11.40Q13.60 11.40 12.58 12.65Q11.55 13.90 11.55 17.10L11.55 23L19.85 23L19.85 17Q19.85 14.90 19.35 13.63Q18.85 12.35 17.98 11.88Q17.10 11.40 15.75 11.40M19.85 29.90L11.55 29.90L11.55 32.55Q11.55 35.10 10.20 36.30Q8.85 37.50 5.55 37.50Q4.15 37.50 3.25 37.10Q2.35 36.70 1.68 35.75Q1.00 34.80 0.68 32.98Q0.35 31.15 0.18 28.57Q0 26 0 22.05Q0 18.60 0.73 15.72Q1.45 12.85 2.68 10.85Q3.90 8.85 5.45 7.32Q7 5.80 8.83 4.95Q10.65 4.10 12.38 3.67Q14.10 3.25 15.85 3.25Q17.95 3.25 20.00 3.82Q22.05 4.40 24.15 5.80Q26.25 7.20 27.83 9.27Q29.40 11.35 30.40 14.65Q31.40 17.95 31.40 22.05Q31.40 28.65 30.93 31.82Q30.45 35 29.33 36.25Q28.20 37.50 25.85 37.50Q22.55 37.50 21.20 36.30Q19.85 35.10 19.85 32.55L19.85 29.90Z"
        class="dash gradient-kefy-1"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M30.80 9.25L30.80 24.15Q30.80 31.45 27.27 34.63Q23.75 37.80 15.40 37.80Q7.45 37.80 3.72 34.40Q0 31 0 24.15L0 9.25Q0 6.60 1.58 4.92Q3.15 3.25 5.55 3.25Q8.50 3.25 10.03 4.35Q11.55 5.45 11.55 8.80L11.55 25.10Q11.60 26.70 12.08 27.65Q12.55 28.60 13.35 28.98Q14.15 29.35 15.40 29.35Q16.65 29.35 17.45 29.05Q18.25 28.75 18.63 28.10Q19 27.45 19.13 26.80Q19.25 26.15 19.25 25.10L19.25 8.75Q19.25 7.05 19.68 5.90Q20.10 4.75 20.98 4.20Q21.85 3.65 22.77 3.45Q23.70 3.25 25 3.25Q27.90 3.25 29.35 4.65Q30.80 6.05 30.80 9.25Z"
        class="dash gradient-kefy-2"
        stroke-width="5"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M19.20 13.20Q19.20 10.80 17.45 9.90Q15.70 9 11.55 9L11.55 17.65Q15.45 17.65 17.33 16.67Q19.20 15.70 19.20 13.20M11.55 30Q11.55 37.50 5.70 37.50Q2.75 37.50 1.38 35.92Q0 34.35 0 30.35L0 9.25Q0 6.35 1.58 4.82Q3.15 3.30 5.70 3.30L16.20 3.30Q22.35 3.30 26.15 6.17Q29.95 9.05 29.95 13.55Q29.95 16.95 28.53 18.88Q27.10 20.80 23.95 21.70Q26.35 21.85 28.40 24.02Q30.45 26.20 30.45 29.45Q30.45 32.75 29.83 34.52Q29.20 36.30 28.05 36.90Q26.90 37.50 24.80 37.50Q21.85 37.50 20.48 36.27Q19.10 35.05 19.10 32.55Q19.10 29.45 18.50 27.77Q17.90 26.10 16.95 25.60Q16 25.10 14.30 25.10L11.55 25.15L11.55 30Z"
        class="dash gradient-kefy-3"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M15.75 11.40Q13.60 11.40 12.58 12.65Q11.55 13.90 11.55 17.10L11.55 23L19.85 23L19.85 17Q19.85 14.90 19.35 13.63Q18.85 12.35 17.98 11.88Q17.10 11.40 15.75 11.40M19.85 29.90L11.55 29.90L11.55 32.55Q11.55 35.10 10.20 36.30Q8.85 37.50 5.55 37.50Q4.15 37.50 3.25 37.10Q2.35 36.70 1.68 35.75Q1.00 34.80 0.68 32.98Q0.35 31.15 0.18 28.57Q0 26 0 22.05Q0 18.60 0.73 15.72Q1.45 12.85 2.68 10.85Q3.90 8.85 5.45 7.32Q7 5.80 8.83 4.95Q10.65 4.10 12.38 3.67Q14.10 3.25 15.85 3.25Q17.95 3.25 20.00 3.82Q22.05 4.40 24.15 5.80Q26.25 7.20 27.83 9.27Q29.40 11.35 30.40 14.65Q31.40 17.95 31.40 22.05Q31.40 28.65 30.93 31.82Q30.45 35 29.33 36.25Q28.20 37.50 25.85 37.50Q22.55 37.50 21.20 36.30Q19.85 35.10 19.85 32.55L19.85 29.90Z"
        class="dash gradient-kefy-1"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>
    
    <div class="w-2"></div>
    
    <div class="kefy-loader-text">KefyStore</div>
    <div class="kefy-loader-subtitle">{% translate "Chargement en cours..." %}</div>
  </div>
</div>

<!-- Loader de paiement -->
<div class="payment-loader" id="paymentLoader">
  <div class="payment-loader-content">
    <svg class="absolute" width="0" height="0">
      <defs>
        <linearGradient id="payment-gradient-1" x1="0" y1="62" x2="0" y2="2" gradientUnits="userSpaceOnUse">
          <stop stop-color="#11998e"></stop>
          <stop offset="1" stop-color="#38ef7d"></stop>
        </linearGradient>
        <linearGradient id="payment-gradient-2" x1="0" y1="64" x2="0" y2="0" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ffc107"></stop>
          <stop offset="1" stop-color="#ff6b6b"></stop>
          <animateTransform
            attributeName="gradientTransform"
            type="rotate"
            values="0 32 32;-270 32 32;-540 32 32;-810 32 32;-1080 32 32"
            dur="6s"
            keyTimes="0;0.125;0.25;0.375;0.5;0.625;0.75;0.875;1"
            repeatCount="indefinite">
          </animateTransform>
        </linearGradient>
        <linearGradient id="payment-gradient-3" x1="0" y1="62" x2="0" y2="2" gradientUnits="userSpaceOnUse">
          <stop stop-color="#667eea"></stop>
          <stop offset="1" stop-color="#764ba2"></stop>
        </linearGradient>
      </defs>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M15.75 11.40Q13.60 11.40 12.58 12.65Q11.55 13.90 11.55 17.10L11.55 23L19.85 23L19.85 17Q19.85 14.90 19.35 13.63Q18.85 12.35 17.98 11.88Q17.10 11.40 15.75 11.40M19.85 29.90L11.55 29.90L11.55 32.55Q11.55 35.10 10.20 36.30Q8.85 37.50 5.55 37.50Q4.15 37.50 3.25 37.10Q2.35 36.70 1.68 35.75Q1.00 34.80 0.68 32.98Q0.35 31.15 0.18 28.57Q0 26 0 22.05Q0 18.60 0.73 15.72Q1.45 12.85 2.68 10.85Q3.90 8.85 5.45 7.32Q7 5.80 8.83 4.95Q10.65 4.10 12.38 3.67Q14.10 3.25 15.85 3.25Q17.95 3.25 20.00 3.82Q22.05 4.40 24.15 5.80Q26.25 7.20 27.83 9.27Q29.40 11.35 30.40 14.65Q31.40 17.95 31.40 22.05Q31.40 28.65 30.93 31.82Q30.45 35 29.33 36.25Q28.20 37.50 25.85 37.50Q22.55 37.50 21.20 36.30Q19.85 35.10 19.85 32.55L19.85 29.90Z"
        class="dash gradient-payment-1"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M30.80 9.25L30.80 24.15Q30.80 31.45 27.27 34.63Q23.75 37.80 15.40 37.80Q7.45 37.80 3.72 34.40Q0 31 0 24.15L0 9.25Q0 6.60 1.58 4.92Q3.15 3.25 5.55 3.25Q8.50 3.25 10.03 4.35Q11.55 5.45 11.55 8.80L11.55 25.10Q11.60 26.70 12.08 27.65Q12.55 28.60 13.35 28.98Q14.15 29.35 15.40 29.35Q16.65 29.35 17.45 29.05Q18.25 28.75 18.63 28.10Q19 27.45 19.13 26.80Q19.25 26.15 19.25 25.10L19.25 8.75Q19.25 7.05 19.68 5.90Q20.10 4.75 20.98 4.20Q21.85 3.65 22.77 3.45Q23.70 3.25 25 3.25Q27.90 3.25 29.35 4.65Q30.80 6.05 30.80 9.25Z"
        class="dash gradient-payment-2"
        stroke-width="5"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M19.20 13.20Q19.20 10.80 17.45 9.90Q15.70 9 11.55 9L11.55 17.65Q15.45 17.65 17.33 16.67Q19.20 15.70 19.20 13.20M11.55 30Q11.55 37.50 5.70 37.50Q2.75 37.50 1.38 35.92Q0 34.35 0 30.35L0 9.25Q0 6.35 1.58 4.82Q3.15 3.30 5.70 3.30L16.20 3.30Q22.35 3.30 26.15 6.17Q29.95 9.05 29.95 13.55Q29.95 16.95 28.53 18.88Q27.10 20.80 23.95 21.70Q26.35 21.85 28.40 24.02Q30.45 26.20 30.45 29.45Q30.45 32.75 29.83 34.52Q29.20 36.30 28.05 36.90Q26.90 37.50 24.80 37.50Q21.85 37.50 20.48 36.27Q19.10 35.05 19.10 32.55Q19.10 29.45 18.50 27.77Q17.90 26.10 16.95 25.60Q16 25.10 14.30 25.10L11.55 25.15L11.55 30Z"
        class="dash gradient-payment-3"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>

    <svg viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        pathLength="360"
        d="M15.75 11.40Q13.60 11.40 12.58 12.65Q11.55 13.90 11.55 17.10L11.55 23L19.85 23L19.85 17Q19.85 14.90 19.35 13.63Q18.85 12.35 17.98 11.88Q17.10 11.40 15.75 11.40M19.85 29.90L11.55 29.90L11.55 32.55Q11.55 35.10 10.20 36.30Q8.85 37.50 5.55 37.50Q4.15 37.50 3.25 37.10Q2.35 36.70 1.68 35.75Q1.00 34.80 0.68 32.98Q0.35 31.15 0.18 28.57Q0 26 0 22.05Q0 18.60 0.73 15.72Q1.45 12.85 2.68 10.85Q3.90 8.85 5.45 7.32Q7 5.80 8.83 4.95Q10.65 4.10 12.38 3.67Q14.10 3.25 15.85 3.25Q17.95 3.25 20.00 3.82Q22.05 4.40 24.15 5.80Q26.25 7.20 27.83 9.27Q29.40 11.35 30.40 14.65Q31.40 17.95 31.40 22.05Q31.40 28.65 30.93 31.82Q30.45 35 29.33 36.25Q28.20 37.50 25.85 37.50Q22.55 37.50 21.20 36.30Q19.85 35.10 19.85 32.55L19.85 29.90Z"
        class="dash gradient-payment-1"
        stroke-width="4"
        stroke-linecap="round"
        stroke-linejoin="round">
      </path>
    </svg>
    
    <div class="w-2"></div>
    
    <div class="payment-loader-text">KefyStore</div>
    <div class="payment-loader-subtitle">{% translate "Traitement du paiement..." %}</div>
  </div>
</div>

<!-- Contenu principal -->
<div class="container py-5">
    {% block review_content %}
    {% endblock %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fonctions pour gérer les loaders
function showKefyLoader(text = "Chargement en cours...") {
    const loader = document.getElementById('kefyLoader');
    const subtitle = loader.querySelector('.kefy-loader-subtitle');
    subtitle.textContent = text;
    loader.classList.add('active');
}

function hideKefyLoader() {
    const loader = document.getElementById('kefyLoader');
    loader.classList.remove('active');
}

function showPaymentLoader(text = "Traitement du paiement...") {
    const loader = document.getElementById('paymentLoader');
    const subtitle = loader.querySelector('.payment-loader-subtitle');
    subtitle.textContent = text;
    loader.classList.add('active');
}

function hidePaymentLoader() {
    const loader = document.getElementById('paymentLoader');
    loader.classList.remove('active');
}

// Afficher le loader au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Cacher le loader immédiatement
    hideKefyLoader();
});

// Intercepter les soumissions de formulaires
document.addEventListener('submit', function(e) {
    if (e.target.classList.contains('review-form')) {
        showKefyLoader('Enregistrement de votre avis...');
    } else if (e.target.classList.contains('payment-form')) {
        showPaymentLoader('Traitement du paiement...');
    }
});

// Intercepter les clics sur les liens
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' && e.target.href && !e.target.href.includes('#')) {
        showKefyLoader('Chargement de la page...');
    }
});

// Fonction pour marquer un avis comme utile
function markHelpful(reviewId) {
    const btn = document.querySelector(`[data-review-id="${reviewId}"]`);
    const countSpan = btn.querySelector('.helpful-count');
    
    fetch(`{% url 'reviews:mark_helpful' 0 %}`.replace('0', reviewId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            countSpan.textContent = data.helpful_count;
            btn.classList.add('pulse-animation');
            setTimeout(() => btn.classList.remove('pulse-animation'), 2000);
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue');
    });
}
</script>
{% endblock %}
